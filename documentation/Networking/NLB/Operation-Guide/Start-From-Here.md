
# 创建高可用网络负载均衡服务

  负载均衡主要由以下五部分组成：负载均衡实例、监听器、后端服务、虚拟服务器组或者高可用组。创建负载均衡及其相关组件、模块时，相互之间存在依赖关系，因此需要按照一定顺序进行创建设置；同样，删除负载均衡及其相关组件、模块时，也需要按照一定顺序进行删除。

  具体顺序请参考下图所示：

 ![NLB创建流程](../../../../image/Networking/NLB/NLB-013.png)

 ![NLB删除流程](../../../../image/Networking/NLB/NLB-014.png)

## 负载均衡实例配置

###  基本属性配置
  
  需要为负载均衡设置名称，用于区别不同的负载均衡实例；需要指定负载均衡实例所属的可用区、私有网络、子网。
  注意：
  负载均衡只能选择同私有网络下的后端服务器进行流量分发；
  负载均衡只能选择有负载均衡实例的可用区内的后端服务器进行流量分发。

### 配置安全组

  创建负载均衡时需指定绑定的安全组，默认为端口全开的安全组。

### 公网/内网类型配置
  
  创建负载均衡实例可选择是否绑定公网IP，绑定了公网IP的负载均衡即为公网类型，可提供面向公网的流量转发服务，不绑定或解绑公网IP后的负载均衡即为内网负载均衡，可提供内网流量转发服务。

## 监听器配置

### 监听协议/端口

- 监听协议：目前提供TCP协议的监听服务。

- 端口：负载均衡实例用于接收请求的监听端口，同一负载均衡实例下不可重复。

- 空闲连接超时：输入范围1~86400秒，默认1800秒。

- 后端服务：定义自负载均衡至后端服务器的流量调度策略、配置等，详见下文。

## 后端服务

### 转发协议/端口

- 后端协议：目前提供TCP协议的后端转发服务。

- 端口：负载均衡后端服务器上开放的用于接收请求的后端端口，不同监听器下后端端口可重复。

### 调度算法

  目前负载均衡支持加权轮询、加权最小连接数、源IP转发3种转发规则。

- 加权轮询：轮询会将请求依次转发至后端服务器，配置了权重后会将流量按权重比例分发，配置权重越高的服务器被分发的几率越大。

- 加权最小连接数：配置了最小连接数会将请求转发至后端连接数最少的一台服务器，配置了权重后会将流量按权重比例分发，最终保证负载均衡与后端服务之间的活跃连接数比例与权重比例一致。

- 源IP转发：配置了源IP转发会将来自同一IP的客户请求转发至后端同一台服务器，保证服务的连贯性。

### 会话保持设置
  
  支持基于TCP连接的会话保持。会话保持缺省超时时间为1440s，为会话保持的最小保证时间，在此期间内、无论NLB以及后端服务如何弹性扩展，所有源、目的IP相同的报文会保证转发到同一个后端服务器。当会话保持时间超时后，报文不能保证转发到同一个后端服务器。

### 源IP透传
 
 目前NLB缺省能够把源自客户端的源IP透传到后端服务器上，不需用户特殊干预与配置。

### 连接耗尽

  连接耗尽（connection draining）是后端服务器优雅退出服务的一种方式。当一个服务器从“虚拟服务器组”或者高可用组（AG）中摘除时，开始启动连接耗尽计时器，此后只有已建立的TCP连接报文会继续向该服务器转发、直到连接耗尽时间超时为止，而新建立的TCP连接将不会向该服务器转发。网络负载均衡的连接耗尽时间范围为【0，3600】秒，缺省为300秒。

### 健康检查

  用户开启健康检查功能后，当检测到后端某台服务器出现问题时会自动停止对该服务器的流量转发并将流量转发至其他健康的服务器，当故障的服务器恢复正常后会自动恢复流量转发。

  针对HTTP服务，负载均衡健康检查机制为：默认由负载均衡系统通过后端服务器内网地址来向该服务器配置的应用服务器发起http head请求，如缺省检查端口则通过业务转发端口进行访问；

  用户也可以指定用作健康检查的URL及健康检查超时时间、检查间隔、健康阈值、不健康阈值、正常状态返回码等来更好的控制健康检查功能。

TCP/HTTP参数配置参考建议如下：

- 响应超时时间：5000毫秒

- 健康检查间隔：3000毫秒

- 不健康阈值：3次

- 健康阈值：3次

### 后端服务器

  后端服务可选择绑定虚拟服务器组或高可用组。

## 虚拟服务器组

  需配置虚拟服务器组名称、端口、权重，权重越高的服务器将被分配到更多的访问请求，可根据实际业务需求进行设置。

## 高可用组

  一组支持批量创建、根据业务负载进行弹性伸缩的云主机实例，支持跨可用区、同机房跨机柜的高可用服务，可挂载至负载均衡后端，高可用组默认使用所绑定后端服务的转发端口，组内实例权重相同。



